---
options:
  go-getter:
    default: gobin -run github.com/hashicorp/go-getter/cmd/go-getter@v1.5.3
  terraform:
    default: ${go-getter} -progress 'github.com/hashicorp/terraform?ref=v0.15.4' /tmp/terraform && cd /tmp/terraform && go run .
    # default: gobin -run github.com/hashicorp/terraform@v0.15.4
tasks:
  convert:
    run:
      - kubectl create deployment jenkins --image jenkins/jenkins:latest --port 8080 --replicas 3 --dry-run=client -o yaml > /tmp/in.yaml
      - cat /tmp/in.yaml | yq e -
      - sleep 2
      - echo 'yamldecode(file("/tmp/in.yaml"))' | terraform console

  install:
    run:
      #- go install github.com/hashicorp/terraform@v0.15.4
      - ${go-getter} -progress 'github.com/hashicorp/terraform?ref=v0.15.4' /tmp/terraform && cd /tmp/terraform && go build . && go install && terraform version
      - go install sigs.k8s.io/kind@v0.11.0 && kind version

  delete:
    run:
      - cd tf && terraform destroy -auto-approve || true
      - kind delete clusters --all

  apply:
    run:
      - task: delete
      - task: 
          name: create
          options:
            name: yhatzee
            k8s: v1.21.1
            # k8s: v1.20.7
            # k8s: v1.19.11
      - task: get
  
  get:
    run:
      - kubectl get nodes -o wide
      - kubectl get pods -A

  create:
    options:
      name:
        short: 'n'
        required: true
      k8s:
        usage: kubernetes version
        short: k
        values:
          - v1.21.1
          - v1.20.7
          - v1.19.11
          - v1.18.19
          - v1.17.17
          - v1.16.15
          - v1.15.12
          - v1.14.10
    run:
      - task: install

      - docker pull kindest/node:${k8s}
      - |
          rm -rf tf
          mkdir -p tf
          cat > tf/main.tf <<-------
          terraform {
            required_providers {
              kind = {
                version = "0.0.9"
                source  = "kyma-incubator/kind"
              }
            }
          }
          provider "kind" {}
          resource "kind_cluster" "default" {
              name = "${name}"
              wait_for_ready = true
              node_image = "kindest/node:${k8s}"
              kind_config  {
                  kind = "Cluster"
                  api_version = "kind.x-k8s.io/v1alpha4"
                  containerd_config_patches = [
                      <<-TOML
                      [plugins."io.containerd.grpc.v1.cri".registry.mirrors."localhost:5000"]
                          endpoint = ["http://kind-registry:5000"]
                      TOML
                  ]
                  node {
                      role = "control-plane"
                  }
                  node {
                      role =  "worker"
                  }
              }
          }          
          ------
      - cd tf && terraform init && terraform plan && terraform apply -auto-approve

      - rm -rf tf && mkdir -p tf
      - |
          cat <<------- > tf/main.tf && cd tf && terraform init && terraform plan && terraform apply -auto-approve
          provider "kubernetes-alpha" {
            config_path = "~/.kube/config"
          }
          resource "kubernetes_manifest" "test-deployment" {
            provider = kubernetes-alpha
            manifest = {
              "apiVersion" = "apps/v1"
              "kind" = "Deployment"
              "metadata" = {
                "creationTimestamp" = null
                "labels" = {
                  "app" = "jenkins"
                }
                "name" = "jenkins"
                "namespace" = "default"
              }
              "spec" = {
                "replicas" = 3
                "selector" = {
                  "matchLabels" = {
                    "app" = "jenkins"
                  }
                }
                "strategy" = {}
                "template" = {
                  "metadata" = {
                    "creationTimestamp" = null
                    "labels" = {
                      "app" = "jenkins"
                    }
                  }
                  "spec" = {
                    "containers" = [
                      {
                        "image" = "jenkins/jenkins:latest"
                        "name" = "jenkins"
                        "ports" = [
                          {
                            "containerPort" = 8080
                            "protocol" = "TCP"
                          },
                        ]
                        "resources" = {}
                      },
                    ]
                  }
                }
              }
            }
            wait_for = {
              fields = {
                "status.readyReplicas" = "3"
              }
            }
          }      
          ------