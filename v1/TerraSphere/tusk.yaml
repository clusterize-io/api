---
options:
  go-getter:
    default: gobin -run github.com/hashicorp/go-getter/cmd/go-getter@v1.5.3
  terraform:
    default: ${go-getter} -progress 'github.com/hashicorp/terraform?ref=v0.15.4' /tmp/terraform && cd /tmp/terraform && go run .
  govc:
    default: go get -u github.com/vmware/govmomi/govc@v0.25.0 && go install github.com/vmware/govmomi/govc && govc

tasks:

  config:
    options:
      user:
        required: true
      pass:
        required: true
      server:
        required: true
    run:
      - mkdir -p ~/.cz/secrets
      - |
          kubectl create secret generic TerraSphere \
            --from-literal user=${user} \
            --from-literal pass=${pass} \
            --from-literal server=${server} \
            --dry-run=client -o yaml > ~/.cz/secrets/TerraSphere.yaml
      - cat ~/.cz/secrets/TerraSphere.yaml | yq e -

  delete:
    options:
      secrets:
        default: ~/.cz/secrets/TerraSphere.yaml
      user:
        default:
          command: yq e '.data.user' ${secrets} | base64 -d
      pass:
        default:
          command: yq e '.data.pass' ${secrets} | base64 -d
      server:
        default:
          command: yq e '.data.server' ${secrets} | base64 -d
    run:
      - set-environment:
          GOVC_USERNAME: ${user}
          GOVC_PASSWORD: ${pass}
          GOVC_URL: ${server}
          GOVC_INSECURE: 1
      - govc find | grep terrasphere | while read vm; do govc vm.destroy $vm || true; done

  create:
    options:
      name:
        default: terrasphere
      secrets:
        default: ~/.cz/secrets/TerraSphere.yaml
      user:
        default:
          command: yq e '.data.user' ${secrets} | base64 -d
      pass:
        default:
          command: yq e '.data.pass' ${secrets} | base64 -d
      server:
        default:
          command: yq e '.data.server' ${secrets} | base64 -d
      pubkey:
        default:
          command: cat ~/.ssh/*.pub
    run:
      - set-environment:
          GOVC_USERNAME: ${user}
          GOVC_PASSWORD: ${pass}
          GOVC_URL: ${server}
          GOVC_INSECURE: 1
      - govc about
      - govc find | grep 'terrasphere-' | while read vm; do govc vm.destroy $vm || true; done

      - set-environment:
          TF_VAR_vsphere_user: ${user}
          TF_VAR_vsphere_password: ${pass}
          TF_VAR_vsphere_server: ${server}
      - rm -rf tf
      - mkdir -p tf
      - |
          cat > tf/main.tf <<-------
          variable "vsphere_user" {
            type = string
          }
          variable "vsphere_password" {
            type = string
          }
          variable "vsphere_server" {
            type = string
          }
          provider "vsphere" {
            user           = var.vsphere_user
            password       = var.vsphere_password
            vsphere_server = var.vsphere_server
            allow_unverified_ssl = true
          }
          data "vsphere_datacenter" "datacenter" {
            name = "dc"
          }
          data "vsphere_datastore" "datastore" {
            name          = "vcsa-nvme"
            datacenter_id = data.vsphere_datacenter.datacenter.id
          }
          data "vsphere_resource_pool" "pool" {
            name          = "ryzen.vmwlab.io/Resources"
            datacenter_id = data.vsphere_datacenter.datacenter.id
          }
          data "vsphere_network" "network" {
            name          = "VM Network"
            datacenter_id = data.vsphere_datacenter.datacenter.id
          }
          data "vsphere_host" "host" {
            name          = "ryzen.vmwlab.io"
            datacenter_id = data.vsphere_datacenter.datacenter.id
          }

      # - |
      #     cat >> tf/main.tf <<-------
      #     resource "vsphere_virtual_machine" "${name}-esxi-70" {
      #       name = "${name}-esxi-70"
      #       num_cpus = 2
      #       memory = 4096
      #       resource_pool_id = data.vsphere_resource_pool.pool.id
      #       datastore_id = data.vsphere_datastore.datastore.id
      #       datacenter_id = data.vsphere_datacenter.datacenter.id
      #       host_system_id = data.vsphere_host.host.id
      #       wait_for_guest_net_timeout = 0
      #       wait_for_guest_ip_timeout  = 0
      #       network_interface {
      #         network_id   = data.vsphere_network.network.id
      #       }
      #       ovf_deploy {
      #         remote_ovf_url   = "https://download3.vmware.com/software/vmw-tools/nested-esxi/Nested_ESXi7.0u2a_Appliance_Template_v1.ova"
      #       }
      #       vapp {
      #         properties = {
      #           "guestinfo.hostname" = "${name}-esxi-70",
      #           "guestinfo.ipaddress" = "",
      #           "guestinfo.netmask" = "",
      #           "guestinfo.gateway" = "",
      #           "guestinfo.dns" = "",
      #           "guestinfo.domain" = "",
      #           "guestinfo.ntp" = "",
      #           "guestinfo.password" = "VMware1!"
      #         }
      #       }
      #     }
      #     ------
      # - |
      #     cat >> tf/main.tf <<-------
      #     resource "vsphere_virtual_machine" "${name}-groovy" {
      #       name = "${name}-groovy"
      #       num_cpus = 2
      #       memory = 4096
      #       resource_pool_id = data.vsphere_resource_pool.pool.id
      #       datastore_id = data.vsphere_datastore.datastore.id
      #       datacenter_id = data.vsphere_datacenter.datacenter.id
      #       host_system_id = data.vsphere_host.host.id
      #       wait_for_guest_net_timeout = 0
      #       wait_for_guest_ip_timeout  = 0
      #       network_interface {
      #         network_id   = data.vsphere_network.network.id
      #       }
      #       ovf_deploy {
      #         remote_ovf_url   = "https://cloud-images.ubuntu.com/groovy/current/groovy-server-cloudimg-amd64.ova"
      #       }
      #       vapp {
      #         properties = {
      #           "instance-id" = "id-ovf"
      #           "hostname" = "${name}-groovy"
      #           "public-keys" = "${pubkey}"
      #         }
      #       }
      #     }
      #     ------
      # - |
      #     cat >> tf/main.tf <<-------
      #     resource "vsphere_virtual_machine" "${name}-focal" {
      #       name = "${name}-focal"
      #       num_cpus = 2
      #       memory = 4096
      #       resource_pool_id = data.vsphere_resource_pool.pool.id
      #       datastore_id = data.vsphere_datastore.datastore.id
      #       datacenter_id = data.vsphere_datacenter.datacenter.id
      #       host_system_id = data.vsphere_host.host.id
      #       wait_for_guest_net_timeout = 0
      #       wait_for_guest_ip_timeout  = 0
      #       network_interface {
      #         network_id   = data.vsphere_network.network.id
      #       }
      #       ovf_deploy {
      #         remote_ovf_url   = "https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64.ova"
      #       }
      #       vapp {
      #         properties = {
      #           "instance-id" = "id-ovf"
      #           "hostname" = "${name}-focal"
      #           "public-keys" = "${pubkey}"
      #         }
      #       }
      #     }
      #     ------

      # - |
      #     cat >> tf/main.tf <<-------
      #     resource "vsphere_virtual_machine" "${name}-bionic" {
      #       name = "${name}-bionic"
      #       num_cpus = 2
      #       memory = 4096
      #       resource_pool_id = data.vsphere_resource_pool.pool.id
      #       datastore_id = data.vsphere_datastore.datastore.id
      #       datacenter_id = data.vsphere_datacenter.datacenter.id
      #       host_system_id = data.vsphere_host.host.id
      #       wait_for_guest_net_timeout = 0
      #       wait_for_guest_ip_timeout  = 0
      #       enable_disk_uuid = true
      #       nested_hv_enabled =true
      #       network_interface {
      #         network_id   = data.vsphere_network.network.id
      #       }
      #       ovf_deploy {
      #         remote_ovf_url   = "https://cloud-images.ubuntu.com/bionic/current/bionic-server-cloudimg-amd64.ova"
      #         disk_provisioning = "thin"
      #       }
      #       vapp {
      #         properties = {
      #           "instance-id" = "id-ovf"
      #           "hostname" = "${name}-bionic"
      #           "public-keys" = "${pubkey}"
      #         }
      #       }
      #     }
      #     ------


      # - |
      #     cat >> tf/main.tf <<-------
      #     resource "vsphere_virtual_machine" "${name}-focal" {
      #       name = "${name}-focal"
      #       num_cpus = 2
      #       memory = 4096
      #       resource_pool_id = data.vsphere_resource_pool.pool.id
      #       datastore_id = data.vsphere_datastore.datastore.id
      #       datacenter_id = data.vsphere_datacenter.datacenter.id
      #       host_system_id = data.vsphere_host.host.id
      #       wait_for_guest_net_timeout = 0
      #       wait_for_guest_ip_timeout  = 0
      #       enable_disk_uuid = true
      #       nested_hv_enabled =true
      #       network_interface {
      #         network_id   = data.vsphere_network.network.id
      #       }
      #       ovf_deploy {
      #         remote_ovf_url   = "https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64.ova"
      #         disk_provisioning = "thin"
      #       }
      #       vapp {
      #         properties = {
      #           "instance-id" = "id-ovf"
      #           "hostname" = "${name}-focal"
      #           "public-keys" = "${pubkey}"
      #         }
      #       }
      #     }
      #     ------



      - |
          cat >> tf/main.tf <<-------
          data "vsphere_ovf_vm_template" "ovf" {
            name = "${name}-focal"
            resource_pool_id = data.vsphere_resource_pool.pool.id
            datastore_id = data.vsphere_datastore.datastore.id
            host_system_id = data.vsphere_host.host.id
            remote_ovf_url   = "https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64.ova"
            ovf_network_map = {
              "Network 1": data.vsphere_network.network.id
            }
          }
          ------

      - |
          cat >> tf/main.tf <<-------
          resource "vsphere_virtual_machine" "vm" {
            datacenter_id = data.vsphere_datacenter.datacenter.id
            name             = data.vsphere_ovf_vm_template.ovf.name
            num_cpus         = 2
            memory           = 3072
            guest_id         = data.vsphere_ovf_vm_template.ovf.guest_id
            resource_pool_id = data.vsphere_ovf_vm_template.ovf.resource_pool_id
            datastore_id     = data.vsphere_ovf_vm_template.ovf.datastore_id
            host_system_id   = data.vsphere_ovf_vm_template.ovf.host_system_id
            dynamic "network_interface" {
              for_each = data.vsphere_ovf_vm_template.ovf.ovf_network_map
              content {
                network_id = network_interface.value
              }
            }
            cdrom {}
            disk {
              label = "disk0"
              size  = 40
            }
            vapp {
              properties = {
                "instance-id" = "id-ovf"
                "hostname" = "${name}-focal"
                "public-keys" = "${pubkey}"
              }
            }
            ovf_deploy {
              ovf_network_map = data.vsphere_ovf_vm_template.ovf.ovf_network_map
              remote_ovf_url  = data.vsphere_ovf_vm_template.ovf.remote_ovf_url
              disk_provisioning = "thin"
            }
          }
          ------

      - |
          cat >> tf/main.tf <<-------
          resource "vsphere_virtual_machine" "other" {
            datacenter_id = data.vsphere_datacenter.datacenter.id
            name             = "${name}-other"
            num_cpus         = 4
            memory           = 2048
            guest_id         = data.vsphere_ovf_vm_template.ovf.guest_id
            resource_pool_id = data.vsphere_ovf_vm_template.ovf.resource_pool_id
            datastore_id     = data.vsphere_ovf_vm_template.ovf.datastore_id
            host_system_id   = data.vsphere_ovf_vm_template.ovf.host_system_id
            dynamic "network_interface" {
              for_each = data.vsphere_ovf_vm_template.ovf.ovf_network_map
              content {
                network_id = network_interface.value
              }
            }
            cdrom {}
            disk {
              label = "disk0"
              size  = 30
            }
            vapp {
              properties = {
                "instance-id" = "id-ovf"
                "hostname" = "${name}-other"
                "public-keys" = "${pubkey}"
              }
            }
            ovf_deploy {
              ovf_network_map = data.vsphere_ovf_vm_template.ovf.ovf_network_map
              remote_ovf_url  = data.vsphere_ovf_vm_template.ovf.remote_ovf_url
              disk_provisioning = "thin"
            }
          }
          ------


      - cd tf && terraform init && terraform plan && terraform apply -auto-approve -lock=false
      - govc find | grep '${name}-' | while read vm; do govc vm.ip -v4 $vm; done

  test:
    run:
      - task: create

  apply:
    run:
      # - task: delete
      - task: create

  convert:
    run:
      - kubectl create deployment jenkins --image jenkins/jenkins:latest --port 8080 --replicas 3 --dry-run=client -o yaml > /tmp/in.yaml
      - cat /tmp/in.yaml | yq e -
      - sleep 2
      - echo 'yamldecode(file("/tmp/in.yaml"))' | terraform console